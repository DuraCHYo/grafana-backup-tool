# .github/workflows/docker-release.yml
name: Docker Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  validate-changelog:
    runs-on: ubuntu-latest
    outputs:
      has_changelog: ${{ steps.check.outputs.has_changelog }}
      version_exists: ${{ steps.check.outputs.version_exists }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Check CHANGELOG.md
        id: check
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð² CHANGELOG
            if grep -q "^\#\# \[${{ steps.get_version.outputs.TAG }}\]" CHANGELOG.md; then
              echo "version_exists=true" >> $GITHUB_OUTPUT
            else
              echo "version_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
            echo "version_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Warn if no CHANGELOG entry
        if: steps.check.outputs.has_changelog == 'true' && steps.check.outputs.version_exists == 'false'
        run: |
          echo "âš ï¸  Warning: No entry found in CHANGELOG.md for version ${{ steps.get_version.outputs.TAG }}"
          echo "Continuing anyway, but please update CHANGELOG.md for future releases."

  docker:
    needs: validate-changelog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            dealfa/grafana-backup-tool
          tags: |
            type=semver,pattern={{version}},prefix=v
            latest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release:
    needs: [validate-changelog, docker]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate intelligent release notes
        id: generate_notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          RELEASE_NOTES_FILE="release_notes_generated.md"
          
          cat > "$RELEASE_NOTES_FILE" << EOF
          # ðŸš€ Grafana Backup Tool $TAG
          
          **Automated backup solution for Grafana configurations**
          
          ## ðŸ“¦ Docker Image
          
          | | |
          |:---|:---|
          | **Image** | \`dealfa/grafana-backup-tool\` |
          | **Tag** | \`$TAG\` |
          | **Pull Command** | \`docker pull dealfa/grafana-backup-tool:$TAG\` |
          | **Docker Hub** | [dealfa/grafana-backup-tool](https://hub.docker.com/r/dealfa/grafana-backup-tool) |
          
          EOF
          
          if [ -f "CHANGELOG.md" ]; then
            echo "## ðŸ“ Changelog" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            
            CHANGELOG_SECTION=$(awk "/^## \\[$TAG\\] - /{flag=1; print; next} /^## \\[/{if(flag) flag=0} flag" CHANGELOG.md)
            
            if [ -n "$CHANGELOG_SECTION" ]; then
              # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ markdown Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
              echo "$CHANGELOG_SECTION" | sed 's/^###/###/' >> "$RELEASE_NOTES_FILE"
            else
              echo "No detailed changelog entry for this version." >> "$RELEASE_NOTES_FILE"
              echo "" >> "$RELEASE_NOTES_FILE"
              
              echo "### Recent Commits:" >> "$RELEASE_NOTES_FILE"
              echo "" >> "$RELEASE_NOTES_FILE"
              if [ -n "$PREV_TAG" ]; then
                git log --pretty=format:"- **%h** %s _(by %an)_" "$PREV_TAG"..HEAD >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- Could not retrieve commits" >> "$RELEASE_NOTES_FILE"
              else
                git log --pretty=format:"- **%h** %s _(by %an)_" -20 >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- Could not retrieve commits" >> "$RELEASE_NOTES_FILE"
              fi
            fi
          else
            echo "## ðŸ“ Recent Changes" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            if [ -n "$PREV_TAG" ]; then
              git log --pretty=format:"- **%h** %s _(by %an)_" "$PREV_TAG"..HEAD >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- No previous tag found" >> "$RELEASE_NOTES_FILE"
            else
              git log --pretty=format:"- **%h** %s _(by %an)_" -20 >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- Initial release" >> "$RELEASE_NOTES_FILE"
            fi
          fi
          
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "## ðŸ” Full Commit History" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          
          if [ -n "$PREV_TAG" ]; then
            echo "Changes since **$PREV_TAG**:\\n" >> "$RELEASE_NOTES_FILE"
            git log --pretty=format:"- \`%h\` %s" --no-merges "$PREV_TAG"..HEAD >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- No commits found" >> "$RELEASE_NOTES_FILE"
          else
            echo "All commits in this release:\\n" >> "$RELEASE_NOTES_FILE"
            git log --pretty=format:"- \`%h\` %s" --no-merges -30 >> "$RELEASE_NOTES_FILE" 2>/dev/null || echo "- Could not retrieve commits" >> "$RELEASE_NOTES_FILE"
          fi
          
          cat >> "$RELEASE_NOTES_FILE" << EOF
          
          ---
          
          ## ðŸš€ Quick Start
          
          \`\`\`bash
          # Pull the image
          docker pull dealfa/grafana-backup-tool:$TAG
          \`\`\`
          
          ## ðŸ“š Documentation
          
          - [Full README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Configuration Options](https://github.com/${{ github.repository }}/blob/main/docs/CONFIGURATION.md)
          - [Troubleshooting Guide](https://github.com/${{ github.repository }}/blob/main/docs/TROUBLESHOOTING.md)
          
          ## ðŸ”— Links
          
          - **GitHub**: [View Repository](https://github.com/${{ github.repository }})
          - **Docker Hub**: [dealfa/grafana-backup-tool](https://hub.docker.com/r/dealfa/grafana-backup-tool)
          - **Issues**: [Report a Bug](https://github.com/${{ github.repository }}/issues/new)
          - **Releases**: [All Versions](https://github.com/${{ github.repository }}/releases)
          
          ---
          
          *This release was automatically generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).*  
          *Docker image build: \`#${{ github.run_number }}\`*
          EOF
          
          echo "Generated release notes:"
          cat "$RELEASE_NOTES_FILE"
          
          echo "notes_file=$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: ${{ steps.generate_notes.outputs.notes_file }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}